# フォルダツリーのキーボードナビゲーションとグローバルショートカットの競合

## 問題の概要

フォルダツリー（RequestCollectionTree）にフォーカスがある状態で、タブ切り替えショートカット（`Cmd/Ctrl+Alt+Arrow`）を押すと、以下の問題が発生します：

1. タブ切り替えは正常に動作する
2. しかし、同時にフォルダのトグル（開閉）も発生してしまう

## 原因

使用しているreact-arboristライブラリが内部でキーボードイベントを独自に処理しており、外部からのイベント制御が困難な状況です。

試みた対策：

- `onKeyDown`でのイベント停止
- `onKeyDownCapture`でのイベント捕獲
- `window`レベルでのイベントインターセプト
- Treeコンポーネントをラップしてイベントを制御

いずれの方法でも、react-arboristの内部処理を完全に制御することができませんでした。

## 影響

- ユーザーがタブ切り替えを頻繁に使う場合、意図しないフォルダの開閉が発生する
- 特にMacユーザーは`Cmd+Option+Arrow`を頻繁に使用するため影響が大きい

## 現在の暫定対応

**Alt+Arrowキーの無効化**

- フォルダツリーにフォーカスがある時、`Alt+Arrow`キーでのフォルダ開閉を無効化
- これにより`Cmd+Alt+Arrow`でのタブ切り替え時にフォルダがトグルしない
- フォルダの開閉は通常の矢印キー、またはマウスクリックで行う

## 提案する解決策

### 短期的な対策

1. **ショートカットキーの変更**

   - タブ切り替えを`Cmd+Shift+[` / `Cmd+Shift+]`などに変更
   - またはフォルダツリーフォーカス時のみ別のショートカットを使用

2. **一時的な警告表示**
   - この問題が解決されるまで、ユーザーに既知の問題として通知

### 長期的な解決策

**フォルダツリー機能の独自実装**

react-arboristへの依存を解消し、以下の機能を独自に実装：

1. **基本機能**

   - ツリー構造の表示
   - 階層に応じたインデント表示
   - フォルダ/リクエストアイテムの表示

2. **インタラクション**

   - フォルダの開閉状態管理
   - アイテムの選択状態管理
   - キーボードナビゲーション（矢印キーでの移動）
   - Enterキーでのリネーム開始
   - ダブルクリックでの開閉/読み込み

3. **ドラッグ&ドロップ**

   - @dnd-kitを使用した並び替え
   - フォルダ間の移動
   - 移動可能/不可能の判定ロジック

4. **その他**
   - コンテキストメニュー
   - スクロール位置の保持
   - パフォーマンス最適化（仮想スクロール）
   - パフォーマンス最適化は別タスクとしても良い

## 実装工数見積もり

独自実装の場合：

- 基本機能: 2-3日
- ドラッグ&ドロップ: 1-2日
- テスト作成: 1日
- 既存機能との統合テスト: 1日

**合計: 5-7日**

## 優先度

中程度 - ユーザビリティに影響はあるが、機能は正常に動作している

## 関連ファイル

- `/src/renderer/src/components/RequestCollectionTree.tsx`
- `/src/renderer/src/hooks/useKeyboardShortcuts.ts`

## 参考リンク

- react-arborist: https://github.com/brimdata/react-arborist
- 関連するPR: #xxx（今回の修正試行）
